name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      CI: "true"
      NODE_ENV: "test"
      #  CRITICAL: Pointing to Remote IP, but specifically the TEST database
      DATABASE_URL: "mysql://rentflow_dev:DevPassword123!@184.168.21.114:3306/rentflow360_test?connect_timeout=60"

      # Using Localhost for the app execution within the CI runner
      NEXTAUTH_URL: "http://localhost:3000"
      NEXT_PUBLIC_API_URL: "http://localhost:3000"
      NEXT_PUBLIC_BASE_URL: "http://localhost:3000"

      # Secrets
      JWT_SECRET: "ci-jwt-secret-secure-enough"
      JWT_REFRESH_SECRET: "ci-refresh-secret-secure-enough"
      NEXTAUTH_SECRET: "ci-nextauth-secret-secure-enough"
      AUTH_SECRET: "ci-auth-secret-secure-enough"
      NEXTAUTH_TRUST_HOST: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # âœ… NEW: Check connectivity to Remote VPS (184...) instead of localhost
      - name: Check Remote Database Connectivity
        shell: bash
        run: |
          for i in {1..10}; do
            # nc -z checks if port is open
            if nc -z 184.168.21.114 3306; then
              echo "Remote MySQL is reachable."
              exit 0
            fi
            echo "Waiting for Remote MySQL... ($i/10)"
            sleep 2
          done
          echo "Could not connect to Remote MySQL."
          exit 1

      - name: Create .env.test
        run: |
          cat > .env.test <<EOF
          NODE_ENV=test
          DATABASE_URL="${DATABASE_URL}"
          NEXTAUTH_URL="${NEXTAUTH_URL}"
          NEXT_PUBLIC_API_URL="${NEXT_PUBLIC_API_URL}"
          NEXT_PUBLIC_BASE_URL="${NEXT_PUBLIC_BASE_URL}"
          JWT_SECRET="${JWT_SECRET}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          AUTH_SECRET="${AUTH_SECRET}"
          NEXTAUTH_TRUST_HOST="true"
          EOF
          # Copy to .env so standard commands pick it up if they forget to use dotenv
          cp .env.test .env

      - name: Generate Prisma Client
        run: npx prisma generate

      #  DANGER ZONE: This wipes the remote rentflow360_test DB
      - name: Reset & Seed Remote Test DB
        run: |
          echo "Syncing Remote Test DB to current Schema..."
          # âœ… Use db push. It ignores migration history and forces the DB 
          # to match your current schema.prisma file exactly.
          npx prisma db push --accept-data-loss --force-reset

          echo "Seeding E2E Data..."
          # Ensure you are running the specific E2E seed
          npx tsx prisma/seed.e2e.ts

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test --project=chromium --reporter=line

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
